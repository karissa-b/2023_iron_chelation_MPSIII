---
title: "fullexp2"
author: "Karissa Barthelson"
date: "2023-09-24"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  autodep = TRUE,
  echo = TRUE, 
  warning = FALSE,
  message = FALSE,
  fig.align = "center", 
  fig.retina = 1,
  out.width ="100%", 
  out.height = "100%"
)
```

```{r packages}
library(tidyverse)
library(readxl)
library(forcats)
library(here)
library(magrittr)
library(scales)
library(readxl)
library(ggpubr)
library(ggeasy)
library(ggfortify)
library(ggbeeswarm)
library(ggforce)
library(ggrepel)
library(kableExtra)

# stat analysis
library(broom)
library(lme4)
library(performance)
library(car)
library(emmeans)
library(glmmTMB)
library(MASS)

# set the default theme for ggplot as theme_bw
theme_set(theme_bw())
```
## Import data
```{r}
# read in the processed data and metadata
meta <-
  read_excel("data/Full exp 1/2023_June_1_ip_DFP_fullexp_meta.xlsx") %>%
  mutate(fish_id = as.character(fish_id),
         genotype = factor(genotype, levels = c("het", "hom")),
         HomeTank = factor(HomeTank, levels =c(1,2,3)),
         sex = as.factor(sex),
         treatment = str_replace(treatment, pattern = "O", replacement = "P"), # typo in meta sheet
         treatment = factor(treatment,
                            levels = c("0.85% saline",
                                       "dose 1 DFP")),
         start.time = as.factor(`start time`),
         Trial = as.factor(Trial)

  )

final_data <- read_csv("data/Full exp 1/processed_data/final_output.csv") %>% 
  dplyr::select(-1) %>% 
  mutate(fish_id = factor(fish_id)) %>% 
  left_join(meta) %>% 
  dplyr::filter(genotype %in% c("het", "hom"))


# make an object which converts the final data to long format. for easier plotting in ggplot
final_data_long <- final_data %>%
  gather(key = "tetras", value = "Count", # convert to long format
         grep("[L|R]{4}", 
              colnames(.))
         )

# also make an object which sums the tetragrams over the hour
final_data_summedoverbins <- final_data %>%
  gather(key = "tetras", value = "Count", # convert to long format
         grep("[L|R]{4}", # select the columns which contain a L or a R four times
              colnames(.))
         ) %>% 
  group_by(fish_id, tetras) %>% 
  mutate(x = sum(Count)) %>% # sum the tetragram counts per fish_id
  dplyr::select(colnames(meta), tetras, x) %>% 
  unique

# read in distance data
# the metadata was added to this file in the preprocessing so i will unselect them here, 
# and re add them so this script is reproducible
distance_data <- read_rds("data/Full exp 1/processed_data/distanceData.rds") %>% 
  dplyr::select(fish_id, BIN_NUM, zone, TOTAL_DISTANCE_IN_ZONE, TOTAL_ENTRIES_IN_ZONE, TOTAL_TIME_SPENT_IN_ZONE)

# create a tibble which contains the conversion of 1 sec bins to 6 or 10 min bins
bin_df <- tibble(bins10 = c(rep(1, 360),
                            rep(2, 360),
                            rep(3, 360),
                            rep(4, 360),
                            rep(5, 360),
                            rep(6, 360),
                            rep(7, 360),
                            rep(8, 360),
                            rep(9, 360),
                            rep(10, 360) %>% as.factor
),
bins6 = c(rep(1, 600),
          rep(2, 600),
          rep(3, 600),
          rep(4, 600),
          rep(5, 600),
          rep(6, 600) %>% as.factor()
),
BIN_NUM = distance_data$BIN_NUM %>% unique
)

# join distance daya with the bin conversion as well as the metadata
distance_data %<>% 
  left_join(bin_df) %>% 
  left_join(meta)
```

# assess whether tracking worked correctly. 

When assesssing behavioural tracking data, it is important to check whether the tracking of your animal was correct. I saved the tracking videos for watching, but also I will check the data to see whether any abnormalities are present.

From my previous experience with zebrafish in a y-maze, fish do not make more than 200 turns per 10 mins in the Y-maze. Plotting out the total number of turns per fish per 10 minute bin show a couple of fish looking very busy. 

```{r}
final_data %>% 
  ggplot(aes(x = fish_id, y = total_turns)) +
  geom_col(aes(fill = total_turns >= 200)) + 
  geom_label_repel(aes(label = fish_id), 
                   data = . %>% 
                     dplyr::filter(total_turns >= 200)) +
  facet_wrap(~bin, nrow = 1) +
  scale_fill_manual(values = c("grey50", "red"))
```

From the plot above, fish `r final_data %>% dplyr::filter(total_turns > 200) %>% .$fish_id %>% unique`appear to be problematic.

```{r}
distance_data %>% 
  group_by(fish_id, bins6) %>%
  mutate(total_distance = sum(TOTAL_DISTANCE_IN_ZONE)) %>%
  dplyr::distinct(bins6, .keep_all = T) %>%
  dplyr::filter(genotype %in% c('het', 'hom')) %>%
  ggplot(aes(x = bins6, y = total_distance, colour = Trial)) +
  geom_jitter(alpha = 0.75) +
  geom_label_repel(aes(label = fish_id),
             data = . %>%
               dplyr::filter(total_distance > 25000) 
              )


```

